name: E2E Tests

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main]

jobs:
  e2e-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # 1. Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Setup Python for backend
      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 3. Install Poetry
      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: '1.8.2'
          virtualenvs-create: true
          virtualenvs-in-project: true

      # 4. Cache Poetry dependencies
      - name: Cache Poetry dependencies
        uses: actions/cache@v4
        with:
          path: backend/.venv
          key: poetry-${{ runner.os }}-${{ hashFiles('backend/poetry.lock') }}
          restore-keys: |
            poetry-${{ runner.os }}-

      # 5. Install backend dependencies
      - name: Install backend dependencies
        working-directory: backend
        run: poetry install --no-interaction

      # 6. Setup Node.js for frontend
      - name: Setup Node.js 24
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      # 7. Install frontend dependencies
      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      # 8. Build frontend
      - name: Build frontend
        working-directory: frontend
        run: npm run build

      # 9. Install Playwright test dependencies
      - name: Install Playwright dependencies
        working-directory: qa
        run: npm ci

      # 10. Install Playwright browsers
      - name: Install Playwright browsers
        working-directory: qa
        run: npx playwright install --with-deps chromium

      # 11. Start backend server (background)
      - name: Start backend server
        working-directory: backend
        run: |
          poetry run flask --app "app:create_app()" run --port 5000 &
          echo "Backend server starting..."
        env:
          FLASK_ENV: testing
          SECRET_KEY: test-secret-key-for-ci

      # 12. Start frontend server (background)
      - name: Start frontend server
        working-directory: frontend
        run: |
          npm run start &
          echo "Frontend server starting..."
        env:
          NODE_ENV: production

      # 13. Wait for services to be ready
      - name: Wait for services
        run: |
          echo "Waiting for backend..."
          timeout 60 bash -c 'until curl -s http://localhost:5000/api/health > /dev/null 2>&1 || curl -s http://localhost:5000 > /dev/null 2>&1; do sleep 2; done' || echo "Backend may not have health endpoint"
          echo "Waiting for frontend..."
          timeout 60 bash -c 'until curl -s http://localhost:3000 > /dev/null 2>&1; do sleep 2; done'
          echo "Services are ready!"

      # 14. Run Playwright tests
      - name: Run E2E tests
        working-directory: qa
        run: npx playwright test --project=chromium
        env:
          CI: true

      # 15. Upload test artifacts on failure
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report
          path: qa/playwright-report/
          retention-days: 7

      - name: Upload test screenshots
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: test-results
          path: qa/test-results/
          retention-days: 7
